<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Smart Irrigation Mobile</title>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root {
  --primary-color: #10b981;
  --secondary-color: #3b82f6;
  --accent-color: #f59e0b;
  --danger-color: #ef4444;
  --success-color: #22c55e;
  --bg-primary: #0f172a;
  --bg-secondary: #1e293b;
  --card-bg: rgba(30, 41, 59, 0.95);
  --text-primary: #f1f5f9;
  --text-secondary: #cbd5e1;
  --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.3);
  --shadow-xl: 0 15px 35px rgba(0, 0, 0, 0.4);
  --tap-highlight: rgba(255, 255, 255, 0.1);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  -webkit-tap-highlight-color: var(--tap-highlight);
  -webkit-touch-callout: none;
  user-select: none;
  touch-action: manipulation;
}

html {
  font-size: 14px;
  height: 100%;
  overflow-x: hidden;
}

body {
  background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
  color: var(--text-primary);
  font-family: 'Poppins', sans-serif;
  min-height: 100%;
  overflow-x: hidden;
  position: relative;
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
}

/* Mobile Header */
header {
  padding: 1rem 1.5rem;
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid rgba(100, 116, 139, 0.3);
  position: sticky;
  top: 0;
  z-index: 1000;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
  min-height: 70px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.header-content {
  display: flex;
  align-items: center;
  gap: 1rem;
  width: 100%;
}

.header-icon {
  font-size: 2.2rem;
  color: var(--primary-color);
  filter: drop-shadow(0 0 10px rgba(16, 185, 129, 0.5));
}

.header-text {
  flex: 1;
}

.header-title {
  font-size: 1.4rem;
  font-weight: 700;
  background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.header-subtitle {
  font-size: 0.8rem;
  color: var(--text-secondary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.connection-status {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.5rem 1rem;
  background: rgba(16, 185, 129, 0.1);
  border-radius: 20px;
  border: 1px solid rgba(16, 185, 129, 0.3);
  font-size: 0.8rem;
}

.connection-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--primary-color);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

/* Main Dashboard */
.dashboard {
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  padding-bottom: 5rem;
}

/* Cards */
.card {
  background: var(--card-bg);
  border-radius: 20px;
  padding: 1.5rem;
  border: 1px solid rgba(100, 116, 139, 0.2);
  box-shadow: var(--shadow-lg);
  backdrop-filter: blur(10px);
  transition: transform 0.2s ease;
}

.card:active {
  transform: scale(0.99);
}

.card-header {
  display: flex;
  align-items: center;
  margin-bottom: 1.5rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid rgba(100, 116, 139, 0.2);
}

.card-header i {
  font-size: 1.5rem;
  margin-right: 1rem;
  color: var(--secondary-color);
}

.card-header h3 {
  font-size: 1.2rem;
  font-weight: 600;
  color: var(--text-primary);
}

/* Sensor Grid */
.sensor-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 1rem;
}

.sensor {
  background: rgba(15, 23, 42, 0.7);
  border-radius: 15px;
  padding: 1.2rem;
  text-align: center;
  border: 1px solid rgba(100, 116, 139, 0.2);
  transition: all 0.2s ease;
  min-height: 170px;
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.sensor:active {
  background: rgba(15, 23, 42, 0.9);
}

.sensor::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
}

.sensor:nth-child(1)::before { background: var(--danger-color); }
.sensor:nth-child(2)::before { background: var(--secondary-color); }
.sensor:nth-child(3)::before { background: var(--primary-color); }
.sensor:nth-child(4)::before { background: var(--accent-color); }

.sensor-icon {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

.sensor:nth-child(1) .sensor-icon { color: var(--danger-color); }
.sensor:nth-child(2) .sensor-icon { color: var(--secondary-color); }
.sensor:nth-child(3) .sensor-icon { color: var(--primary-color); }
.sensor:nth-child(4) .sensor-icon { color: var(--accent-color); }

.sensor-label {
  font-size: 0.9rem;
  color: var(--text-secondary);
  margin-bottom: 0.5rem;
  font-weight: 500;
}

/* Gauges */
.gauge-container {
  position: relative;
  width: 85px;
  height: 85px;
  margin: 0 auto 0.5rem;
}

.gauge {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  position: relative;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  background: conic-gradient(var(--gauge-color) 0deg, rgba(255, 255, 255, 0.1) 0deg);
}

.gauge::before {
  content: '';
  position: absolute;
  width: 75%;
  height: 75%;
  background: rgba(15, 23, 42, 0.9);
  border-radius: 50%;
  z-index: 1;
}

.value {
  position: relative;
  z-index: 2;
  font-size: 1.4rem;
  font-weight: 700;
  color: var(--text-primary);
}

.sensor-unit {
  font-size: 0.8rem;
  color: var(--text-secondary);
}

.sensor-status {
  font-size: 0.75rem;
  color: var(--text-secondary);
  opacity: 0.8;
  margin-top: 0.5rem;
}

/* Motion Sensor */
.motion-indicator {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  margin: 0.5rem 0;
}

.motion-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--accent-color);
  margin-bottom: 0.5rem;
  animation: pulse 2s infinite;
}

.motion-text {
  font-size: 1rem;
  font-weight: 600;
  color: var(--text-primary);
}

/* Control Panel */
.control-panel {
  text-align: center;
}

.mode-toggle {
  margin: 1.5rem 0;
}

.toggle-label {
  display: block;
  margin-bottom: 1rem;
  font-size: 1rem;
  color: var(--text-secondary);
  font-weight: 500;
}

/* Toggle Switch */
.toggle-container {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.toggle-switch {
  position: relative;
  width: 90px;
  height: 40px;
  background: rgba(15, 23, 42, 0.8);
  border-radius: 25px;
  cursor: pointer;
  border: 2px solid rgba(100, 116, 139, 0.3);
  touch-action: manipulation;
}

.toggle-knob {
  position: absolute;
  top: 4px;
  left: 4px;
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: linear-gradient(145deg, var(--secondary-color), #2563eb);
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-size: 1rem;
}

.toggle-switch.manual .toggle-knob {
  left: 54px;
  background: linear-gradient(145deg, var(--accent-color), #d97706);
}

.mode-label {
  font-weight: 600;
  font-size: 1rem;
  padding: 0.5rem 1rem;
  border-radius: 10px;
  background: rgba(15, 23, 42, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.1);
  min-width: 70px;
  text-align: center;
}

.mode-label.auto { color: var(--secondary-color); }
.mode-label.manual { color: var(--accent-color); }

/* Pump Button */
.pump-control {
  margin: 1.5rem 0;
}

.pump-button {
  padding: 1rem 2rem;
  border: none;
  border-radius: 15px;
  font-size: 1.1rem;
  font-weight: 700;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 0.8rem;
  width: 100%;
  max-width: 280px;
  text-transform: uppercase;
  position: relative;
  overflow: hidden;
  touch-action: manipulation;
}

.pump-button:active {
  transform: scale(0.98);
}

.pump-button.on {
  background: linear-gradient(145deg, var(--primary-color), #059669);
  color: white;
  box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4);
}

.pump-button.off {
  background: linear-gradient(145deg, var(--danger-color), #dc2626);
  color: white;
  box-shadow: 0 8px 20px rgba(239, 68, 68, 0.4);
}

/* Status Indicator */
.status-indicator {
  margin-top: 1.5rem;
  padding: 1rem;
  border-radius: 12px;
  background: rgba(15, 23, 42, 0.7);
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.8rem;
  text-align: center;
}

.status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--primary-color);
  animation: pulse 2s infinite;
  flex-shrink: 0;
}

/* Footer */
footer {
  text-align: center;
  padding: 1rem;
  color: var(--text-secondary);
  font-size: 0.8rem;
  background: rgba(15, 23, 42, 0.7);
  margin-top: 1rem;
  border-top: 1px solid rgba(100, 116, 139, 0.3);
}

/* Value Change Animation */
@keyframes valueChange {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

.value-changed {
  animation: valueChange 0.3s ease;
}

/* Mobile Bottom Navigation */
.mobile-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  background: rgba(15, 23, 42, 0.95);
  backdrop-filter: blur(20px);
  border-top: 1px solid rgba(100, 116, 139, 0.3);
  padding: 0.5rem;
  z-index: 1000;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding-bottom: calc(0.5rem + env(safe-area-inset-bottom));
}

.nav-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 0.5rem;
  border: none;
  background: none;
  color: var(--text-secondary);
  font-size: 0.7rem;
  cursor: pointer;
  transition: all 0.2s ease;
  border-radius: 10px;
  min-width: 55px;
  touch-action: manipulation;
}

.nav-btn:active {
  background: rgba(100, 116, 139, 0.2);
}

.nav-btn.active {
  color: var(--primary-color);
}

.nav-icon {
  font-size: 1.2rem;
  margin-bottom: 0.2rem;
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(15, 23, 42, 0.9);
  backdrop-filter: blur(10px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  gap: 1rem;
}

.loading-spinner {
  width: 50px;
  height: 50px;
  border: 3px solid rgba(100, 116, 139, 0.3);
  border-top-color: var(--primary-color);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Toast Notifications */
.toast {
  position: fixed;
  bottom: 80px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--card-bg);
  color: var(--text-primary);
  padding: 1rem 1.5rem;
  border-radius: 10px;
  box-shadow: var(--shadow-xl);
  z-index: 1001;
  animation: slideUp 0.3s ease;
  border-left: 4px solid var(--primary-color);
  max-width: 90%;
  text-align: center;
}

@keyframes slideUp {
  from { transform: translateX(-50%) translateY(100%); opacity: 0; }
  to { transform: translateX(-50%) translateY(0); opacity: 1; }
}

/* Responsive Design */
@media (max-width: 360px) {
  .sensor-grid {
    grid-template-columns: 1fr;
  }

  .sensor {
    min-height: 150px;
  }

  .header-title {
    font-size: 1.2rem;
  }
}

@media (min-width: 768px) {
  .dashboard {
    max-width: 768px;
    margin: 0 auto;
  }

  .mobile-nav {
    display: none;
  }
}

/* Landscape Mode */
@media (orientation: landscape) and (max-height: 500px) {
  .dashboard {
    padding: 1rem;
    gap: 1rem;
  }

  .card {
    padding: 1rem;
  }

  .sensor-grid {
    grid-template-columns: repeat(4, 1fr);
  }

  .sensor {
    min-height: 140px;
    padding: 0.8rem;
  }

  .gauge-container {
    width: 70px;
    height: 70px;
  }
}
</style>
</head>

<body>

<!-- Loading Overlay -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-spinner"></div>
  <div>Connecting to irrigation system...</div>
</div>

<!-- Toast Notification -->
<div class="toast" id="toast" style="display: none;"></div>

<!-- Header -->
<header>
  <div class="header-content">
    <div class="header-icon">
      <i class="fas fa-tint"></i>
    </div>
    <div class="header-text">
      <h1 class="header-title">Smart Irrigation</h1>
      <div class="header-subtitle">Mobile Control Panel</div>
    </div>
    <div class="connection-status">
      <div class="connection-dot" id="connectionDot"></div>
      <span id="connectionText">Connecting...</span>
    </div>
  </div>
</header>

<!-- Main Dashboard -->
<main class="dashboard" id="dashboard">

  <!-- Sensor Data Card -->
  <div class="card">
    <div class="card-header">
      <i class="fas fa-chart-line"></i>
      <h3>Live Sensor Data</h3>
    </div>

    <div class="sensor-grid">

      <!-- Temperature -->
      <div class="sensor">
        <div class="sensor-icon">
          <i class="fas fa-thermometer-half"></i>
        </div>
        <div class="sensor-label">Temperature</div>
        <div class="gauge-container">
          <div class="gauge" id="temp-gauge" style="--gauge-color: #ef4444;">
            <div class="value" id="temp-value">--<span class="sensor-unit">°C</span></div>
          </div>
        </div>
        <div class="sensor-status">Optimal: 18-30°C</div>
      </div>

      <!-- Humidity -->
      <div class="sensor">
        <div class="sensor-icon">
          <i class="fas fa-tint"></i>
        </div>
        <div class="sensor-label">Humidity</div>
        <div class="gauge-container">
          <div class="gauge" id="hum-gauge" style="--gauge-color: #3b82f6;">
            <div class="value" id="hum-value">--<span class="sensor-unit">%</span></div>
          </div>
        </div>
        <div class="sensor-status">Ideal: 40-70%</div>
      </div>

      <!-- Soil Moisture -->
      <div class="sensor">
        <div class="sensor-icon">
          <i class="fas fa-seedling"></i>
        </div>
        <div class="sensor-label">Soil Moisture</div>
        <div class="gauge-container">
          <div class="gauge" id="soil-gauge" style="--gauge-color: #10b981;">
            <div class="value" id="soil-value">--<span class="sensor-unit">%</span></div>
          </div>
        </div>
        <div class="sensor-status">Water below 30%</div>
      </div>

      <!-- Motion Detection -->
      <div class="sensor">
        <div class="sensor-icon">
          <i class="fas fa-running"></i>
        </div>
        <div class="sensor-label">Motion</div>
        <div class="motion-indicator">
          <div class="motion-dot" id="motion-dot"></div>
          <div class="motion-text" id="motion-text">No Motion</div>
        </div>
        <div class="sensor-status" id="motion-time">Last: --:--</div>
      </div>

    </div>
  </div>

  <!-- Control Panel Card -->
  <div class="card control-panel">
    <div class="card-header">
      <i class="fas fa-cogs"></i>
      <h3>Pump Control</h3>
    </div>

    <div class="mode-toggle">
      <div class="toggle-label">Operation Mode</div>
      <div class="toggle-container">
        <div class="mode-label auto">AUTO</div>
        <div class="toggle-switch" id="modeSwitch">
          <div class="toggle-knob">
            <i class="fas fa-adjust"></i>
          </div>
        </div>
        <div class="mode-label manual">MANUAL</div>
      </div>
    </div>

    <div class="pump-control">
      <button id="motorBtn" class="pump-button off">
        <i class="fas fa-power-off"></i>
        <span id="motorBtnText">START PUMP</span>
      </button>
    </div>

    <div class="status-indicator">
      <div class="status-dot" id="status-dot"></div>
      <div id="status-text">Connecting to system...</div>
    </div>

    <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(15, 23, 42, 0.5); border-radius: 10px;">
      <div><i class="fas fa-info-circle" style="color: var(--secondary-color); margin-right: 0.5rem;"></i>
      <span id="system-status">System initializing...</span></div>
    </div>
  </div>

</main>

<!-- Footer -->
<footer>
  <div id="last-update">Last update: --:--:--</div>
  <div style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.7;">ESP8266 + Firebase</div>
</footer>

<!-- Bottom Navigation -->
<nav class="mobile-nav">
  <button class="nav-btn active" id="navDashboard">
    <i class="fas fa-home nav-icon"></i>
    <span>Dashboard</span>
  </button>

  <button class="nav-btn" id="navRefresh">
    <i class="fas fa-sync-alt nav-icon"></i>
    <span>Refresh</span>
  </button>

  <button class="nav-btn" id="navSettings">
    <i class="fas fa-cog nav-icon"></i>
    <span>Settings</span>
  </button>
</nav>

<script type="module">
// Import Firebase modules
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, onValue, set, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyDsqAOV_cLrjHmAkWAWqQQRQSeYkQpEPRY",
  authDomain: "project1-6ea3b.firebaseapp.com",
  databaseURL: "https://project1-6ea3b-default-rtdb.firebaseio.com",
  projectId: "project1-6ea3b",
  storageBucket: "project1-6ea3b.appspot.com",
  messagingSenderId: "869331089130",
  appId: "1:869331089130:web:cd3f2ef414c1b0e6f62c11"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const database = getDatabase(app);

// DOM Elements
const loadingOverlay = document.getElementById('loadingOverlay');
const toast = document.getElementById('toast');
const connectionDot = document.getElementById('connectionDot');
const connectionText = document.getElementById('connectionText');
const lastUpdate = document.getElementById('last-update');
const systemStatus = document.getElementById('system-status');

// Sensor elements
const tempValue = document.getElementById('temp-value');
const humValue = document.getElementById('hum-value');
const soilValue = document.getElementById('soil-value');
const motionText = document.getElementById('motion-text');
const motionDot = document.getElementById('motion-dot');
const motionTime = document.getElementById('motion-time');

// Control elements
const modeSwitch = document.getElementById('modeSwitch');
const motorBtn = document.getElementById('motorBtn');
const motorBtnText = document.getElementById('motorBtnText');
const statusDot = document.getElementById('status-dot');
const statusText = document.getElementById('status-text');

// Navigation elements
const navDashboard = document.getElementById('navDashboard');
const navRefresh = document.getElementById('navRefresh');
const navSettings = document.getElementById('navSettings');

// State variables
let isOnline = false;
let lastMotionTime = null;
let beepSound = null;
let connectionTimeout = null;

// Initialize the application
function initApp() {
  console.log('Initializing Smart Irrigation Mobile App...');

  // Create beep sound for motion alerts
  beepSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  beepSound.volume = 0.3;

  // Set up Firebase connection monitoring
  monitorConnection();

  // Load sensor data
  loadSensorData();

  // Load control data
  loadControlData();

  // Set up event listeners
  setupEventListeners();

  // Start update timer
  startUpdateTimer();
}

// Monitor Firebase connection
function monitorConnection() {
  const connectedRef = ref(database, ".info/connected");

  onValue(connectedRef, (snap) => {
    isOnline = snap.val() === true;

    if (isOnline) {
      showToast("Connected to irrigation system", "success");
      connectionText.textContent = "Online";
      connectionDot.style.background = "var(--primary-color)";
      loadingOverlay.style.display = "none";

      // Set up disconnect handler
      const deviceRef = ref(database, 'device/mobile');
      set(deviceRef, {
        connected: true,
        lastSeen: serverTimestamp(),
        platform: 'mobile-web',
        userAgent: navigator.userAgent
      });

      onDisconnect(deviceRef).set({
        connected: false,
        lastSeen: serverTimestamp()
      });

    } else {
      connectionText.textContent = "Offline";
      connectionDot.style.background = "var(--danger-color)";
      systemStatus.textContent = "Disconnected from system";
      showToast("Disconnected from irrigation system", "error");
    }
  });
}

// Load sensor data from Firebase
function loadSensorData() {
  console.log('Loading sensor data from Firebase...');

  const sensorsRef = ref(database, "sensors");

  onValue(sensorsRef, (snapshot) => {
    if (!snapshot.exists()) {
      console.log("No sensor data available");
      showToast("No sensor data received", "warning");
      return;
    }

    const data = snapshot.val();
    console.log('Sensor data received:', data);

    // Update temperature
    if (data.temperature !== undefined) {
      updateGauge("temp-gauge", data.temperature, 50);
      tempValue.innerHTML = `${data.temperature}<span class="sensor-unit">°C</span>`;
      animateValueChange("temp-value");
    }

    // Update humidity
    if (data.humidity !== undefined) {
      updateGauge("hum-gauge", data.humidity, 100);
      humValue.innerHTML = `${data.humidity}<span class="sensor-unit">%</span>`;
      animateValueChange("hum-value");
    }

    // Update soil moisture
    if (data.soil !== undefined) {
      updateGauge("soil-gauge", data.soil, 100);
      soilValue.innerHTML = `${data.soil}<span class="sensor-unit">%</span>`;
      animateValueChange("soil-value");
    }

    // Update motion detection
    if (data.pir !== undefined) {
      if (data.pir) {
        motionText.textContent = "MOTION DETECTED!";
        motionText.style.color = "var(--accent-color)";
        motionDot.style.animation = "pulse 0.5s infinite";
        lastMotionTime = new Date();
        motionTime.textContent = `Last: ${lastMotionTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;

        // Play beep sound
        if (beepSound) {
          beepSound.play().catch(e => console.log("Audio error:", e));
        }

        // Vibrate if supported
        if (navigator.vibrate) {
          navigator.vibrate([100, 50, 100]);
        }
      } else {
        motionText.textContent = "No Motion";
        motionText.style.color = "var(--text-primary)";
        motionDot.style.animation = "pulse 2s infinite";
      }
    }

    // Update last update time
    updateTimeDisplay();
    systemStatus.textContent = "All systems operational";
  }, (error) => {
    console.error("Error loading sensor data:", error);
    showToast("Error loading sensor data", "error");
  });
}

// Load control data from Firebase
function loadControlData() {
  console.log('Loading control data from Firebase...');

  // Monitor mode
  const modeRef = ref(database, "control/mode");
  onValue(modeRef, (snapshot) => {
    const mode = snapshot.val() || "AUTO";

    if (mode === "MANUAL") {
      modeSwitch.classList.add("manual");
      motorBtn.style.display = "inline-flex";
      statusText.textContent = "Manual Mode Active";
      statusDot.style.background = "var(--accent-color)";
    } else {
      modeSwitch.classList.remove("manual");
      motorBtn.style.display = "none";
      statusText.textContent = "Auto Mode Active";
      statusDot.style.background = "var(--primary-color)";
    }
  });

  // Monitor relay state
  const relayRef = ref(database, "control/relay");
  onValue(relayRef, (snapshot) => {
    const relayState = snapshot.val();

    if (relayState === 1) {
      motorBtnText.textContent = "STOP PUMP";
      motorBtn.classList.remove("off");
      motorBtn.classList.add("on");
    } else {
      motorBtnText.textContent = "START PUMP";
      motorBtn.classList.remove("on");
      motorBtn.classList.add("off");
    }
  });
}

// Update gauge visualization
function updateGauge(gaugeId, value, maxValue = 100) {
  const gauge = document.getElementById(gaugeId);
  const percentage = Math.min((value / maxValue) * 100, 100);

  // Determine color based on value
  let color;
  if (percentage < 30) {
    color = "#ef4444"; // Red
  } else if (percentage < 60) {
    color = "#f59e0b"; // Orange
  } else {
    color = "#10b981"; // Green
  }

  // Update gauge color
  gauge.style.setProperty('--gauge-color', color);

  // Update gauge fill
  gauge.style.background = `conic-gradient(${color} 0deg, ${color} ${percentage * 3.6}deg, rgba(255, 255, 255, 0.1) ${percentage * 3.6}deg, rgba(255, 255, 255, 0.1) 360deg)`;

  // Add animation effect
  gauge.style.transform = "scale(1.1)";
  setTimeout(() => {
    gauge.style.transform = "scale(1)";
  }, 150);
}

// Animate value changes
function animateValueChange(elementId) {
  const element = document.getElementById(elementId);
  element.classList.add("value-changed");
  setTimeout(() => {
    element.classList.remove("value-changed");
  }, 300);
}

// Update time display
function updateTimeDisplay() {
  const now = new Date();
  const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', second: '2-digit' });
  lastUpdate.textContent = `Last update: ${timeString}`;
}

// Show toast notification
function showToast(message, type = "info") {
  toast.textContent = message;

  // Set color based on type
  switch(type) {
    case "success":
      toast.style.borderLeftColor = "var(--primary-color)";
      break;
    case "error":
      toast.style.borderLeftColor = "var(--danger-color)";
      break;
    case "warning":
      toast.style.borderLeftColor = "var(--accent-color)";
      break;
    default:
      toast.style.borderLeftColor = "var(--secondary-color)";
  }

  // Show toast
  toast.style.display = "block";

  // Auto hide after 3 seconds
  setTimeout(() => {
    toast.style.display = "none";
  }, 3000);
}

// Set up event listeners
function setupEventListeners() {
  // Mode toggle switch
  modeSwitch.addEventListener('click', toggleMode);
  modeSwitch.addEventListener('touchstart', (e) => {
    e.preventDefault();
    modeSwitch.style.transform = "scale(0.95)";
  });
  modeSwitch.addEventListener('touchend', (e) => {
    e.preventDefault();
    modeSwitch.style.transform = "scale(1)";
    toggleMode();
  });

  // Pump button
  motorBtn.addEventListener('click', toggleRelay);
  motorBtn.addEventListener('touchstart', (e) => {
    e.preventDefault();
    motorBtn.style.transform = "scale(0.98)";
  });
  motorBtn.addEventListener('touchend', (e) => {
    e.preventDefault();
    motorBtn.style.transform = "scale(1)";
    toggleRelay();
  });

  // Navigation buttons
  navDashboard.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    setActiveNav(navDashboard);
  });

  navRefresh.addEventListener('click', () => {
    // Force refresh data
    showToast("Refreshing data...", "info");
    systemStatus.textContent = "Refreshing data...";

    // Simulate refresh by updating time
    updateTimeDisplay();

    // Reset active nav
    setActiveNav(navDashboard);

    setTimeout(() => {
      systemStatus.textContent = "Data refreshed";
      showToast("Data refreshed successfully", "success");
    }, 1000);
  });

  navSettings.addEventListener('click', () => {
    showToast("Settings feature coming soon", "info");
    setActiveNav(navDashboard); // Keep dashboard active
  });

  // Handle online/offline events
  window.addEventListener('online', () => {
    showToast("You are back online", "success");
  });

  window.addEventListener('offline', () => {
    showToast("You are offline", "error");
  });
}

// Set active navigation button
function setActiveNav(activeButton) {
  [navDashboard, navRefresh, navSettings].forEach(btn => {
    btn.classList.remove('active');
  });
  activeButton.classList.add('active');
}

// Toggle mode between AUTO and MANUAL
function toggleMode() {
  if (!isOnline) {
    showToast("Cannot change mode while offline", "error");
    return;
  }

  const newMode = modeSwitch.classList.contains("manual") ? "AUTO" : "MANUAL";

  set(ref(database, "control/mode"), newMode)
    .then(() => {
      showToast(`Mode changed to ${newMode}`, "success");

      // Vibrate for feedback
      if (navigator.vibrate) {
        navigator.vibrate(50);
      }
    })
    .catch((error) => {
      console.error("Error changing mode:", error);
      showToast("Failed to change mode", "error");
    });
}

// Toggle relay (pump) state
function toggleRelay() {
  if (!isOnline) {
    showToast("Cannot control pump while offline", "error");
    return;
  }

  const newState = motorBtnText.textContent.includes("START") ? 1 : 0;
  const action = newState === 1 ? "starting" : "stopping";

  showToast(`${action} pump...`, "info");

  set(ref(database, "control/relay"), newState)
    .then(() => {
      showToast(`Pump ${newState === 1 ? 'started' : 'stopped'}`, "success");

      // Vibrate for feedback
      if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
      }
    })
    .catch((error) => {
      console.error("Error toggling relay:", error);
      showToast("Failed to control pump", "error");
    });
}

// Start update timer
function startUpdateTimer() {
  setInterval(() => {
    updateTimeDisplay();

    // Update motion time if available
    if (lastMotionTime) {
      const now = new Date();
      const diffMinutes = Math.floor((now - lastMotionTime) / (1000 * 60));

      if (diffMinutes > 0) {
        motionTime.textContent = `Last: ${diffMinutes}m ago`;
      }
    }
  }, 30000); // Update every 30 seconds
}

// Initialize the app when DOM is loaded
document.addEventListener('DOMContentLoaded', () => {
  // Show loading overlay initially
  loadingOverlay.style.display = "flex";

  // Initialize after a short delay
  setTimeout(initApp, 1000);

  // Hide loading overlay if Firebase takes too long
  setTimeout(() => {
    if (loadingOverlay.style.display !== "none") {
      loadingOverlay.style.display = "none";
      showToast("Connection timeout. Check your internet.", "warning");
    }
  }, 10000);
});

// Handle page visibility changes
document.addEventListener('visibilitychange', () => {
  if (document.hidden) {
    console.log('App is in background');
  } else {
    console.log('App is in foreground');
    updateTimeDisplay();
  }
});

// Prevent accidental refresh
window.addEventListener('beforeunload', (e) => {
  if (isOnline) {
    // Optional: Add confirmation for leaving
    // e.preventDefault();
    // e.returnValue = '';
  }
});

// Handle errors
window.addEventListener('error', (error) => {
  console.error('Global error:', error);
  showToast("An error occurred", "error");
});

// PWA Install prompt (optional)
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;

  // You could show an install button here
  console.log('PWA install available');
});
</script>

</body>
</html>